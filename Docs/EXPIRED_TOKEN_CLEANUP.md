# Сервис очистки истекших токенов

## Описание

`ExpiredTokenCleanupService` - это фоновый сервис, который автоматически удаляет истекшие refresh токены из базы данных. Сервис работает как `BackgroundService` и выполняет очистку с заданным интервалом.

## Функциональность

- Автоматическое удаление истекших refresh токенов
- Настраиваемый интервал очистки
- Логирование процесса очистки
- Обработка ошибок с повторными попытками
- Возможность отключения сервиса через конфигурацию

## Конфигурация

Сервис настраивается через секцию `TokenCleanup` в `appsettings.json`:

```json
{
  "TokenCleanup": {
    "EnableCleanup": true,
    "CleanupIntervalHours": 1,
    "RetryDelayMinutes": 5
  }
}
```

### Параметры конфигурации

- `EnableCleanup` (bool) - Включить/отключить сервис очистки (по умолчанию: true)
- `CleanupIntervalHours` (int) - Интервал между очистками в часах (по умолчанию: 1)
- `RetryDelayMinutes` (int) - Задержка перед повторной попыткой при ошибке в минутах (по умолчанию: 5)

## Архитектура

### Domain Layer
- `IRefreshTokenRepository.GetExpiredTokensAsync()` - метод для получения истекших токенов

### Infrastructure Layer
- `ExpiredTokenCleanupService` - основной сервис очистки
- `TokenCleanupSettings` - конфигурация сервиса
- `RefreshTokenRepository.GetExpiredTokensAsync()` - реализация получения истекших токенов

### Регистрация сервиса

Сервис автоматически регистрируется в `InfrastructureServiceExtensions`:

```csharp
services.AddHostedService<ExpiredTokenCleanupService>();
```

## Логирование

Сервис логирует следующие события:
- Запуск и остановка сервиса
- Количество найденных истекших токенов
- Успешное удаление токенов
- Ошибки при очистке

## Тестирование

### Unit Tests
- `ExpiredTokenCleanupServiceTests` - тесты логики сервиса
- Проверка работы с пустым списком токенов
- Проверка удаления истекших токенов
- Проверка обработки ошибок

### Integration Tests
- `ExpiredTokenCleanupServiceIntegrationTests` - интеграционные тесты с реальной базой данных
- Проверка удаления истекших токенов из базы данных
- Проверка сохранения активных токенов

## Использование

Сервис запускается автоматически при старте приложения и работает в фоновом режиме. Для отключения сервиса установите `EnableCleanup: false` в конфигурации.

## Безопасность

- Сервис удаляет только истекшие токены
- Активные токены не затрагиваются
- Операции выполняются в транзакции
- Ошибки логируются для мониторинга 