@using System.Net.Http.Json
@using DotNetCleanTemplate.Shared.Common
@using DotNetCleanTemplate.Shared.DTOs
@using MediatR
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 400px; overflow-y: auto">
            <MudText Typo="Typo.h6" Class="mb-4">
                Управление ролями пользователя: @UserName
            </MudText>

            @if (_isLoading)
            {
                <MudProgressCircular Indeterminate="true" Class="d-flex justify-center" />
            }
            else
            {
                <MudGrid>
                    <!-- Текущие роли пользователя -->
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Текущие роли:</MudText>
                        @if (_userRoles != null && _userRoles.Any())
                        {
                                                    <div class="d-flex flex-wrap gap-2">
                            @foreach (var role in _userRoles)
                            {
                                <MudButton Variant="Variant.Filled" 
                                          Color="Color.Primary" 
                                          Size="Size.Small"
                                          OnClick="@(() => RemoveRole(role))"
                                          Class="mr-2 mb-2">
                                    @role.Name
                                    @if (role.IsDefault)
                                    {
                                        <MudText Typo="Typo.caption" Class="ml-1">(Дефолтная)</MudText>
                                    }
                                    <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Class="ml-1" />
                                </MudButton>
                            }
                        </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Нет назначенных ролей</MudText>
                        }
                    </MudItem>

                    <!-- Доступные роли для назначения -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Доступные роли:</MudText>
                        @if (_availableRoles != null && _availableRoles.Any())
                        {
                                                    <div class="d-flex flex-wrap gap-2">
                            @foreach (var role in _availableRoles)
                            {
                                <MudButton Variant="Variant.Outlined" 
                                          Color="Color.Secondary" 
                                          Size="Size.Small"
                                          OnClick="@(() => AddRole(role))"
                                          Class="mr-2 mb-2">
                                    @role.Name
                                </MudButton>
                            }
                        </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Нет доступных ролей для назначения</MudText>
                        }
                    </MudItem>
                </MudGrid>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Закрыть</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public Guid UserId { get; set; }
    [Parameter] public string UserName { get; set; } = string.Empty;
    [Parameter] public EventCallback OnDialogClosed { get; set; }

    private bool _isLoading = true;
    private List<RoleDto>? _userRoles;
    private List<RoleDto>? _availableRoles;
    private List<RoleDto>? _allRoles;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            // Загружаем все роли
            var allRolesResponse = await Http.GetAsync("/administration/roles");
            if (allRolesResponse.IsSuccessStatusCode)
            {
                var allRolesResult = await allRolesResponse.Content.ReadFromJsonAsync<Result<List<RoleDto>>>();
                _allRoles = allRolesResult?.Value ?? new List<RoleDto>();
            }

            // Загружаем роли пользователя
            var userResponse = await Http.GetAsync($"/administration/users/{UserId}/with-roles");
            if (userResponse.IsSuccessStatusCode)
            {
                var userResult = await userResponse.Content.ReadFromJsonAsync<Result<UserWithRolesDto>>();
                var user = userResult?.Value;
                _userRoles = user?.Roles?.ToList() ?? new List<RoleDto>();
            }

            // Вычисляем доступные роли
            if (_allRoles != null && _userRoles != null)
            {
                _availableRoles = _allRoles.Where(r => !_userRoles.Any(ur => ur.Id == r.Id)).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при загрузке данных: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AddRole(RoleDto role)
    {
        try
        {
            var assignRoleDto = new AssignRoleToUserDto
            {
                UserId = UserId,
                RoleId = role.Id
            };

            var response = await Http.PostAsJsonAsync("/administration/assign-role", assignRoleDto);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<Result<Unit>>();
                if (result?.IsSuccess == true)
                {
                    Snackbar.Add($"Роль '{role.Name}' успешно назначена пользователю", Severity.Success);
                    await LoadData(); // Перезагружаем данные
                }
                else
                {
                    var errorMessage = result?.Errors?.FirstOrDefault()?.Message ?? "Неизвестная ошибка";
                    Snackbar.Add($"Ошибка при назначении роли: {errorMessage}", Severity.Error);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Ошибка HTTP: {response.StatusCode}. {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при назначении роли: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveRole(RoleDto role)
    {
        try
        {
            var removeRoleDto = new RemoveRoleFromUserDto
            {
                UserId = UserId,
                RoleId = role.Id
            };

            var response = await Http.PostAsJsonAsync("/administration/remove-role", removeRoleDto);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<Result<Unit>>();
                if (result?.IsSuccess == true)
                {
                    Snackbar.Add($"Роль '{role.Name}' успешно удалена у пользователя", Severity.Success);
                    await LoadData(); // Перезагружаем данные
                }
                else
                {
                    var errorMessage = result?.Errors?.FirstOrDefault()?.Message ?? "Неизвестная ошибка";
                    Snackbar.Add($"Ошибка при удалении роли: {errorMessage}", Severity.Error);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Ошибка HTTP: {response.StatusCode}. {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка при удалении роли: {ex.Message}", Severity.Error);
        }
    }

    private async Task Cancel()
    {
        MudDialog.Cancel();
        await OnDialogClosed.InvokeAsync();
    }
} 